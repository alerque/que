#!/bin/sh

set -x

# Error out of script if _anything_ goes wrong
set -e

# Make sure we have the tools (otherwise we should be running a system init routine instead)
which git > /dev/null
which mr > /dev/null
which vcsh > /dev/null

# Clone the very base bit in
cd $HOME

#TODO check for SSH auth credentials first

git config --global user.email "caleb@alerque.com"
git config --global user.name "Caleb Maclennan"

if [ ! -d .ssh/ ]; then
	mkdir -p .ssh
	echo -e "Host github.com\n\tIdentityFile ~/.ssh/github\n\tStrictHostKeyChecking no\n" >> .ssh/config
	cp /tmp/ghk .ssh/github
	chmod 600 .ssh/github
	eval $(ssh-agent)
	ssh-add .ssh/github
fi

if [ ! -d .config/vcsh/repo.d/que.git ]; then
	vcsh clone git@github.com:alerque/que.git
fi

mr up

exit

case $HOSTNAME in
	lemur|pars|laylek)
		# Desktop stuff
		ln -s .config/mr/{available.d,repo.d}/awesome.vcsh
		#ln -s .config/mr/{available.d,repo.d}/urxvt.vcsh
		#ln -s .config/mr/{available.d,repo.d}/xorg.vcsh
		;;
	camelion)
		# Server stuff
		;;
esac

exit

## old version....

TMPDIR=$(mktemp -d $TMPDIR/XXXXXX)

# This package is for $HOME
cd

# TODO: install pre-requisits
which git || exit

git clone https://github.com/alerque/que.git $TMPDIR
rsync -avb $TMPDIR/ $HOME/ 
rm -rf $TMPDIR

#curl -#L https://github.com/alerque/que/tarball/master |
#	tar -xzv --strip-components 1
